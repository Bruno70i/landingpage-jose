{
  "version": 3,
  "sources": ["../../../../birpc/dist/index.mjs"],
  "sourcesContent": ["const TYPE_REQUEST = \"q\";\nconst TYPE_RESPONSE = \"s\";\nconst DEFAULT_TIMEOUT = 6e4;\nfunction defaultSerialize(i) {\n  return i;\n}\nconst defaultDeserialize = defaultSerialize;\nconst { clearTimeout, setTimeout } = globalThis;\nconst random = Math.random.bind(Math);\nfunction createBirpc($functions, options) {\n  const {\n    post,\n    on,\n    off = () => {\n    },\n    eventNames = [],\n    serialize = defaultSerialize,\n    deserialize = defaultDeserialize,\n    resolver,\n    bind = \"rpc\",\n    timeout = DEFAULT_TIMEOUT\n  } = options;\n  let $closed = false;\n  const _rpcPromiseMap = /* @__PURE__ */ new Map();\n  let _promiseInit;\n  async function _call(method, args, event, optional) {\n    if ($closed)\n      throw new Error(`[birpc] rpc is closed, cannot call \"${method}\"`);\n    const req = { m: method, a: args, t: TYPE_REQUEST };\n    if (optional)\n      req.o = true;\n    const send = async (_req) => post(serialize(_req));\n    if (event) {\n      await send(req);\n      return;\n    }\n    if (_promiseInit) {\n      try {\n        await _promiseInit;\n      } finally {\n        _promiseInit = void 0;\n      }\n    }\n    let { promise, resolve, reject } = createPromiseWithResolvers();\n    const id = nanoid();\n    req.i = id;\n    let timeoutId;\n    async function handler(newReq = req) {\n      if (timeout >= 0) {\n        timeoutId = setTimeout(() => {\n          try {\n            const handleResult = options.onTimeoutError?.(method, args);\n            if (handleResult !== true)\n              throw new Error(`[birpc] timeout on calling \"${method}\"`);\n          } catch (e) {\n            reject(e);\n          }\n          _rpcPromiseMap.delete(id);\n        }, timeout);\n        if (typeof timeoutId === \"object\")\n          timeoutId = timeoutId.unref?.();\n      }\n      _rpcPromiseMap.set(id, { resolve, reject, timeoutId, method });\n      await send(newReq);\n      return promise;\n    }\n    try {\n      if (options.onRequest)\n        await options.onRequest(req, handler, resolve);\n      else\n        await handler();\n    } catch (e) {\n      if (options.onGeneralError?.(e) !== true)\n        throw e;\n      return;\n    } finally {\n      clearTimeout(timeoutId);\n      _rpcPromiseMap.delete(id);\n    }\n    return promise;\n  }\n  const $call = (method, ...args) => _call(method, args, false);\n  const $callOptional = (method, ...args) => _call(method, args, false, true);\n  const $callEvent = (method, ...args) => _call(method, args, true);\n  const $callRaw = (options2) => _call(options2.method, options2.args, options2.event, options2.optional);\n  const builtinMethods = {\n    $call,\n    $callOptional,\n    $callEvent,\n    $callRaw,\n    $rejectPendingCalls,\n    get $closed() {\n      return $closed;\n    },\n    $close,\n    $functions\n  };\n  const rpc = new Proxy({}, {\n    get(_, method) {\n      if (Object.prototype.hasOwnProperty.call(builtinMethods, method))\n        return builtinMethods[method];\n      if (method === \"then\" && !eventNames.includes(\"then\") && !(\"then\" in $functions))\n        return void 0;\n      const sendEvent = (...args) => _call(method, args, true);\n      if (eventNames.includes(method)) {\n        sendEvent.asEvent = sendEvent;\n        return sendEvent;\n      }\n      const sendCall = (...args) => _call(method, args, false);\n      sendCall.asEvent = sendEvent;\n      return sendCall;\n    }\n  });\n  function $close(customError) {\n    $closed = true;\n    _rpcPromiseMap.forEach(({ reject, method }) => {\n      const error = new Error(`[birpc] rpc is closed, cannot call \"${method}\"`);\n      if (customError) {\n        customError.cause ??= error;\n        return reject(customError);\n      }\n      reject(error);\n    });\n    _rpcPromiseMap.clear();\n    off(onMessage);\n  }\n  function $rejectPendingCalls(handler) {\n    const entries = Array.from(_rpcPromiseMap.values());\n    const handlerResults = entries.map(({ method, reject }) => {\n      if (!handler) {\n        return reject(new Error(`[birpc]: rejected pending call \"${method}\".`));\n      }\n      return handler({ method, reject });\n    });\n    _rpcPromiseMap.clear();\n    return handlerResults;\n  }\n  async function onMessage(data, ...extra) {\n    let msg;\n    try {\n      msg = deserialize(data);\n    } catch (e) {\n      if (options.onGeneralError?.(e) !== true)\n        throw e;\n      return;\n    }\n    if (msg.t === TYPE_REQUEST) {\n      const { m: method, a: args, o: optional } = msg;\n      let result, error;\n      let fn = await (resolver ? resolver(method, $functions[method]) : $functions[method]);\n      if (optional)\n        fn ||= () => void 0;\n      if (!fn) {\n        error = new Error(`[birpc] function \"${method}\" not found`);\n      } else {\n        try {\n          result = await fn.apply(bind === \"rpc\" ? rpc : $functions, args);\n        } catch (e) {\n          error = e;\n        }\n      }\n      if (msg.i) {\n        if (error && options.onError)\n          options.onError(error, method, args);\n        if (error && options.onFunctionError) {\n          if (options.onFunctionError(error, method, args) === true)\n            return;\n        }\n        if (!error) {\n          try {\n            await post(serialize({ t: TYPE_RESPONSE, i: msg.i, r: result }), ...extra);\n            return;\n          } catch (e) {\n            error = e;\n            if (options.onGeneralError?.(e, method, args) !== true)\n              throw e;\n          }\n        }\n        try {\n          await post(serialize({ t: TYPE_RESPONSE, i: msg.i, e: error }), ...extra);\n        } catch (e) {\n          if (options.onGeneralError?.(e, method, args) !== true)\n            throw e;\n        }\n      }\n    } else {\n      const { i: ack, r: result, e: error } = msg;\n      const promise = _rpcPromiseMap.get(ack);\n      if (promise) {\n        clearTimeout(promise.timeoutId);\n        if (error)\n          promise.reject(error);\n        else\n          promise.resolve(result);\n      }\n      _rpcPromiseMap.delete(ack);\n    }\n  }\n  _promiseInit = on(onMessage);\n  return rpc;\n}\nconst cacheMap = /* @__PURE__ */ new WeakMap();\nfunction cachedMap(items, fn) {\n  return items.map((i) => {\n    let r = cacheMap.get(i);\n    if (!r) {\n      r = fn(i);\n      cacheMap.set(i, r);\n    }\n    return r;\n  });\n}\nfunction createBirpcGroup(functions, channels, options = {}) {\n  const getChannels = () => typeof channels === \"function\" ? channels() : channels;\n  const getClients = (channels2 = getChannels()) => cachedMap(channels2, (s) => createBirpc(functions, { ...options, ...s }));\n  function _boardcast(method, args, event, optional) {\n    const clients = getClients();\n    return Promise.all(clients.map((c) => c.$callRaw({ method, args, event, optional })));\n  }\n  function $call(method, ...args) {\n    return _boardcast(method, args, false);\n  }\n  function $callOptional(method, ...args) {\n    return _boardcast(method, args, false, true);\n  }\n  function $callEvent(method, ...args) {\n    return _boardcast(method, args, true);\n  }\n  const broadcastBuiltin = {\n    $call,\n    $callOptional,\n    $callEvent\n  };\n  const broadcastProxy = new Proxy({}, {\n    get(_, method) {\n      if (Object.prototype.hasOwnProperty.call(broadcastBuiltin, method))\n        return broadcastBuiltin[method];\n      const client = getClients();\n      const callbacks = client.map((c) => c[method]);\n      const sendCall = (...args) => {\n        return Promise.all(callbacks.map((i) => i(...args)));\n      };\n      sendCall.asEvent = async (...args) => {\n        await Promise.all(callbacks.map((i) => i.asEvent(...args)));\n      };\n      return sendCall;\n    }\n  });\n  function updateChannels(fn) {\n    const channels2 = getChannels();\n    fn?.(channels2);\n    return getClients(channels2);\n  }\n  getClients();\n  return {\n    get clients() {\n      return getClients();\n    },\n    functions,\n    updateChannels,\n    broadcast: broadcastProxy,\n    /**\n     * @deprecated use `broadcast`\n     */\n    // @ts-expect-error deprecated\n    boardcast: broadcastProxy\n  };\n}\nfunction createPromiseWithResolvers() {\n  let resolve;\n  let reject;\n  const promise = new Promise((res, rej) => {\n    resolve = res;\n    reject = rej;\n  });\n  return { promise, resolve, reject };\n}\nconst urlAlphabet = \"useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict\";\nfunction nanoid(size = 21) {\n  let id = \"\";\n  let i = size;\n  while (i--)\n    id += urlAlphabet[random() * 64 | 0];\n  return id;\n}\n\nexport { DEFAULT_TIMEOUT, cachedMap, createBirpc, createBirpcGroup };\n"],
  "mappings": "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",
  "names": []
}
